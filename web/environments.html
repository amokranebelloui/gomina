<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Environments</title>
    <script src="lib/react.js"></script>
    <script src="lib/react-dom.js"></script>
    <script src="lib/babel.min.js"></script>
    <script src="lib/sockjs-0.3.4.min.js"></script>
    <script type="text/babel" src="components/data.js"></script>
    <script type="text/babel" src="components/gomina.js"></script>
    <script type="text/babel" src="components/project.js"></script>
    <script type="text/babel" src="components/layout.js"></script>
    <script type="text/babel" src="components/env.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

    class EnvApp extends React.Component {
        constructor(props) {
            super(props);
            this.state = {env: 'PROD', realtime: false, instances: this.props.instances}
            this.connect = this.connect.bind(this)
            this.switch = this.switch.bind(this)
        }
        connect() {
            this.sock = new SockJS('/realtime');

            const thisComponent = this;
            var eventsDiv = this.eventsList;
            this.sock.onopen = function() {
                console.log('open');
                thisComponent.setState({realtime: true});
                eventsDiv.innerHTML = eventsDiv.innerHTML + 'Open<br>';
                //sock.send('test');
            };

            this.sock.onmessage = function(e) {
                var r = Math.floor((Math.random() * 3) + 1);
                var fakeStatus = r == 1 ? 'LIVE' : r == 2 ? 'LOADING' : 'DOWN';
                console.log('message', e.data, fakeStatus);
                eventsDiv.innerHTML = eventsDiv.innerHTML + ' ' + e.data + ' ' + fakeStatus + '<br>';

                thisComponent.state.instances[0].status = fakeStatus;
                thisComponent.setState({instances: thisComponent.state.instances});
            };

            this.sock.onclose = function() {
                console.log('close');
                thisComponent.setState({realtime: false});
                eventsDiv.innerHTML = eventsDiv.innerHTML + 'Close<br>';
            };
        }
        switch(newStatus) {
            if (this.state != newStatus) {
                if (newStatus) {
                    this.connect();
                }
                else {
                    this.sock.close();
                }
            }
        }
        componentDidMount() {
            //this.connect();
        }
        selectEnv(env) {
            this.setState({env: env});
        }
        render() {
            const instancesByEnv = groupBy(this.state.instances, 'env');
            const instances = instancesByEnv[this.state.env];

            return (
                <AppLayout title={"Environment '" + this.state.env + "'"}>
                    <div style={{float: 'right'}}>
                        <Toggle toggled={this.state.realtime} onToggleChanged={this.switch} />
                        <div ref={node => this.eventsList = node}></div>
                    </div>
                    <button onClick={e => this.selectEnv('PROD')}>PROD</button>
                    <button onClick={e => this.selectEnv('UAT')}>UAT</button>
                    <EnvironmentLogical instances={instances} />
                </AppLayout>
            );
        }
    }

    ReactDOM.render(<EnvApp instances={allInstances} />, document.getElementById('root'));

</script>

</body>
</html>